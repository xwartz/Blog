{"componentChunkName":"component---src-templates-blog-post-js","path":"/ci-cd-for-react-native-app/","result":{"data":{"site":{"siteMetadata":{"title":"XWARTZ","author":"xwartz"}},"markdownRemark":{"id":"6053978e-e142-5b08-a488-6a31ea4089b9","html":"<p>本篇文章主要讲如何使用 <a href=\"https://jenkins.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Jenkins</a> 为 <code class=\"language-text\">React Native</code> 项目搭建 <code class=\"language-text\">CI/CD</code>。</p>\n<p>涉及内容如下：</p>\n<ol>\n<li>gitflow</li>\n<li>Jenkins 搭建</li>\n<li>权限控制</li>\n<li>发布到测试平台</li>\n<li>Android：打包、加固、zipalign、签名、多渠道包</li>\n<li>iOS：证书、打包、发布</li>\n<li>自动生成 tag、release note</li>\n</ol>\n<p>当然，上面的一些内容本身是为了项目的特定需求而做的，不一定适用其他项目。</p>\n<p>另外，因为我自身并不是 DevOps 和原生 App 开发者，所以可能存在一些错误使用。</p>\n<h2 id=\"需求\"><a href=\"#%E9%9C%80%E6%B1%82\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>需求</h2>\n<p>任何功能的产生必定从需求开始，开发者根据明确的需求，来做技术调研和实现方案。</p>\n<p>对于一家普通的小公司，<code class=\"language-text\">CI/CD</code> 的需求可能如下：</p>\n<ol>\n<li>实时得对提交到 <code class=\"language-text\">Github Repo</code> 的代码执行单元测试，并反馈结果到 <code class=\"language-text\">Commit</code>、<code class=\"language-text\">PR</code></li>\n<li>代码 review 阶段可以触发打包，如 <code class=\"language-text\">PR</code> 下评论</li>\n<li>有不同的开发环境，因此需要打不同环境的包(<code class=\"language-text\">dev</code>、<code class=\"language-text\">staging</code>、<code class=\"language-text\">production</code>)</li>\n<li>将打好的包发布到测试平台，并通知相关人员进行测试</li>\n<li>如果是 production 的包，需要自动提交到应用商店</li>\n<li>Android 需要发布多个平台，因此需要多渠道包</li>\n</ol>\n<p>对于去中心化钱包，有更严格的<em>安全需求</em>：</p>\n<ol>\n<li><strong>避免代码泄露，禁止第三方可触达</strong></li>\n<li><strong>权限管理，控制触发打包的人员权限</strong></li>\n</ol>\n<p>因此，出于以上安全需求的考虑，不使用第三方的服务，而是购买一台 <a href=\"https://www.apple.com/mac-pro/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Mac Pro</a> 通过 <code class=\"language-text\">Jenkins</code> 自己搭建 <code class=\"language-text\">CI</code>，还能节省不少支出。</p>\n<h2 id=\"概览\"><a href=\"#%E6%A6%82%E8%A7%88\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>概览</h2>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/cdf6200ee6525349e3d640619dd3bcb4/15812/ci.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 61.803444782168185%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALFAFP2wrfAAACEUlEQVQoz2VTa3PaMBD0//8jnelMPyRNSLGxSUoKDuAyzZQwCW3KM5NC8EuW39b2rPAw9MPO6nTSzmnvpCAPilOIjDjbMS+KjBVFzoosdYs88+Ra5nK+5QMU2kQJSmC33u9t+YHf44610dn0YNpdmOwW02hMuZjOHN9TSEjQRYEilFzGKOMtyrjndYTmqOLijymuFt+E7qviiQ8pn4iiPF+BgoKjiF0w+wVIfciYqs0TH1nsURE+LN+Ebl/j7FcHtakJwzMwDh+ookSeRQXKby/Cj7cIg1cPg3WIuccgEhJK2d6GQdAjER2tTRMtEta9RkWQSWtEHkood+sEX5YpriYMtUWCkRsD4t3THfquiYbbgLm8hLlW0fB1jPlQCkoPSRSZQ/CgWG8JtEUEbcZQJ/65oqeGNuLQQcRtpJGLPuviq62hP/uM3uISTarwsRSMA2QpR2KPsBp+AJvpJLhJoM456s8O1GWMkc2l4PrvHIG/RkFeWiR4QxW2x5/QnpzD8BvbCmPpoUhssn4OEb1C4QkHi0MEaQSfOElD2ZjDKIT4ToLNgPybnKH1UoPOjP2TSw/LM9RZ4gg0h6Xxx6j6R4MNi5rScjRY03N0Zxdoutq2KfH/XRZZ2YBjVEVLwX5AT97U0X38CIuqNDwNT+HwMDbVwT79HdWfsxO85wO0nWt0lyqslYFb7wbP4eP7TzkR/AczNYgrlEZN8AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"CI\"\n        title=\"\"\n        src=\"/blog/static/cdf6200ee6525349e3d640619dd3bcb4/b9e4f/ci.png\"\n        srcset=\"/blog/static/cdf6200ee6525349e3d640619dd3bcb4/cf440/ci.png 148w,\n/blog/static/cdf6200ee6525349e3d640619dd3bcb4/d2d38/ci.png 295w,\n/blog/static/cdf6200ee6525349e3d640619dd3bcb4/b9e4f/ci.png 590w,\n/blog/static/cdf6200ee6525349e3d640619dd3bcb4/f9b6a/ci.png 885w,\n/blog/static/cdf6200ee6525349e3d640619dd3bcb4/15812/ci.png 987w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>选择使用监听仓库更新的方式，而不是通过 <code class=\"language-text\">webhooks</code>，主要出于安全考量。</p>\n<h2 id=\"触发方式\"><a href=\"#%E8%A7%A6%E5%8F%91%E6%96%B9%E5%BC%8F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>触发方式</h2>\n<p><code class=\"language-text\">CI</code> 本身是被动的执行者，执行任务的过程是由触发开启的，然后周而复始的工作着，\n替代人力去做重复的事。</p>\n<p>提高效率的同时，也为了避免一些人容易犯的低级错误。</p>\n<p>上图中，我们主要通过两种方式触发 <code class=\"language-text\">CI</code>：</p>\n<h4 id=\"1-push-commit\"><a href=\"#1-push-commit\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. push commit</h4>\n<p>当有新的代码提交时，希望能够实时的反馈该修改是否对原有的代码造成破坏，\n因此触发 <code class=\"language-text\">CI</code> 执行单元测试任务。</p>\n<h4 id=\"2-pr-下评论\"><a href=\"#2-pr-%E4%B8%8B%E8%AF%84%E8%AE%BA\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. PR 下评论</h4>\n<p>当有人创建 <code class=\"language-text\">Pull Request</code> 时，相关人员会进行 <code class=\"language-text\">code review</code>，\n并可能指派人员打包给到 QA 进行测试。</p>\n<p>此时，可通过在 PR 下评论 <code class=\"language-text\">build dev</code> | <code class=\"language-text\">build staging</code> | <code class=\"language-text\">build prod</code>，\n来触发 <code class=\"language-text\">CI</code> 基于此 PR 打对应环境的包。</p>\n<blockquote>\n<p>触发方式需要根据团队的开发规范、gitflow 来适配，以上是基于前文的<a href=\"../developmemt-guidelines\">团队开发规范</a>。</p>\n</blockquote>\n<h2 id=\"jenkins-搭建\"><a href=\"#jenkins-%E6%90%AD%E5%BB%BA\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Jenkins 搭建</h2>\n<h3 id=\"基础\"><a href=\"#%E5%9F%BA%E7%A1%80\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>基础</h3>\n<p>首先，我们需要一个可编译 RN 项目的环境，因此需在 Mac 上安装一些基础软件：</p>\n<ol>\n<li><a href=\"https://developer.apple.com/xcode/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Xcode</a></li>\n<li><a href=\"https://developer.android.com/studio\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Android Studio</a></li>\n<li><a href=\"https://brew.sh/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Homebrew</a></li>\n<li><a href=\"https://cocoapods.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pod</a>：<code class=\"language-text\">sudo gem install cocoapods</code></li>\n<li>java：<code class=\"language-text\">brew cask install caskroom/versions/java8</code></li>\n<li>gradle：<code class=\"language-text\">brew install gradle</code></li>\n<li>git：<code class=\"language-text\">brew install git</code></li>\n<li>nodejs：<code class=\"language-text\">brew install node</code></li>\n<li>yarn：<code class=\"language-text\">brew install yarn</code></li>\n<li>fastlane：<code class=\"language-text\">gem install fastlane -NV</code></li>\n</ol>\n<h3 id=\"编译配置\"><a href=\"#%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>编译配置</h3>\n<p>这里就不展开讲如何配置编译 RN 了，可以参考以下链接：</p>\n<p><strong>iOS:</strong></p>\n<ul>\n<li><a href=\"https://facebook.github.io/react-native/docs/running-on-device\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Running On Device</a></li>\n<li><a href=\"https://docs.jiguang.cn//jpush/client/iOS/ios_cer_guide/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">iOS 证书设置指南</a></li>\n</ul>\n<p><strong>Android:</strong></p>\n<ul>\n<li><a href=\"https://developer.android.com/studio/publish/app-signing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sign your app</a></li>\n<li><a href=\"https://facebook.github.io/react-native/docs/signed-apk-android\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Publishing to Google Play Store</a></li>\n</ul>\n<h3 id=\"安装-jenkins\"><a href=\"#%E5%AE%89%E8%A3%85-jenkins\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装 Jenkins</h3>\n<p>推荐使用 brew 安装</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">brew <span class=\"token function\">install</span> jenkins</code></pre></div>\n<h3 id=\"启动-jenkins\"><a href=\"#%E5%90%AF%E5%8A%A8-jenkins\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>启动 Jenkins</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">jenkins --httpPort<span class=\"token operator\">=</span><span class=\"token number\">4567</span></code></pre></div>\n<p>浏览器打开 <a href=\"http://localhost:4567/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://localhost:4567/</a>，创建账户(注意保管)。</p>\n<h3 id=\"安装-plugin\"><a href=\"#%E5%AE%89%E8%A3%85-plugin\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装 Plugin</h3>\n<p>进入 Jenkins 插件管理页面，<a href=\"http://localhost:4567/pluginManager/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://localhost:4567/pluginManager/</a></p>\n<p><strong>只安装必要的插件，其他通过自己编写脚本实现，这是为了：</strong></p>\n<ol>\n<li>不过度依赖 Jenkins，即使没有 Jenkins，也可在自己电脑执行</li>\n<li>更灵活，方便迁移到其他 CI</li>\n</ol>\n<p>因此，只需要装以下两个插件即可。</p>\n<p><strong>1. GitHub Plugin</strong></p>\n<p>我们需要对 github 仓库做 clone、push 等操作，首先安装 <a href=\"https://wiki.jenkins.io/display/JENKINS/Github+Plugin\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub Plugin</a>。</p>\n<p>配置：<code class=\"language-text\">Manage Jenkins</code> -> <code class=\"language-text\">Configure System</code> -> <code class=\"language-text\">GitHub</code></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/fea52a8b61032ba71144cc612f37975e/386eb/github-plugin.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.02298850574713%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAARlAAAEZQAGA43XUAAAA40lEQVQoz5WRTQ6CMBCFObEX8HhuXBmi7ogQkkpCMQjDtKWFUscixMQf9Fs07WTem5dpUJYlY0wIYa0d/iRwzmmtR7F7geqccwB41jg3aNPVqAL/+IiU0hhDPZ2n91jbq9aAaO+TJ783tBOFBxHvrdbSZJQ6cF9RSlFmCl9wfq2qOEkaAKqbrn9M/oUxHUWg7aZpeim4VGZBTN00uULdDw8LSg5NA0KKRTF9gd+TnfcCiNFhz8JdJ/DX2LMZHdV2c1qvxDFcEGdZFkVRHMd5nr/+yIKYMhsPXUaxkk12ZmRX1/UNffOEo5AzOQsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"github-plugin\"\n        title=\"\"\n        src=\"/blog/static/fea52a8b61032ba71144cc612f37975e/b9e4f/github-plugin.png\"\n        srcset=\"/blog/static/fea52a8b61032ba71144cc612f37975e/cf440/github-plugin.png 148w,\n/blog/static/fea52a8b61032ba71144cc612f37975e/d2d38/github-plugin.png 295w,\n/blog/static/fea52a8b61032ba71144cc612f37975e/b9e4f/github-plugin.png 590w,\n/blog/static/fea52a8b61032ba71144cc612f37975e/386eb/github-plugin.png 870w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>需要去 github 设置页面生成 <a href=\"https://github.com/settings/tokens/new\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">personal access token</a>。</p>\n<p><strong>2. GitHub pull request builder plugin</strong></p>\n<p>监听 PR 的评论，执行相关的指令，并且需要控制权限，可安装 <a href=\"https://wiki.jenkins.io/display/JENKINS/GitHub+pull+request+builder+plugin\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub pull request builder plugin</a>。</p>\n<p>配置：<code class=\"language-text\">Manage Jenkins</code> -> <code class=\"language-text\">Configure System</code> -> <code class=\"language-text\">GitHub pull requests builder</code></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/aaa584b7a077355fe3c517612e4dd23c/c31c2/github-pr-plugin.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 51.42517814726841%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABCklEQVQoz5VS226EIBT0///OB1+6D+tqNPV+AxRBpw4NG2Pa1E4yAY4wnhkImqZBmqYoisJxmiYQ27Zh3/c3jTGO1lqs64plWRxZ417WzcGABX444yzkxdu2Rdd1GIYBfd+jrmtUVQWllNs3LxqDmBH8JuJrfqQQu5dSvrv3PyO1XiGURnAVOq/Ph4QQrhuCljkn53k+RolxEhjlqcOfcO2QhwnaZ96fRYlXksAesa3Gop/UfUGGzk4JfzntkenH44HkEGWm1m73Bc+37sEXEkURwjBE/Hy62r8s+9fAPClWliXK46a11hBSYRQ3MrxelrdMEdpmrlmWOXHzl+Vrp9c5kef5t+U4dusvxSgPq672+PUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"pr-plugin\"\n        title=\"\"\n        src=\"/blog/static/aaa584b7a077355fe3c517612e4dd23c/b9e4f/github-pr-plugin.png\"\n        srcset=\"/blog/static/aaa584b7a077355fe3c517612e4dd23c/cf440/github-pr-plugin.png 148w,\n/blog/static/aaa584b7a077355fe3c517612e4dd23c/d2d38/github-pr-plugin.png 295w,\n/blog/static/aaa584b7a077355fe3c517612e4dd23c/b9e4f/github-pr-plugin.png 590w,\n/blog/static/aaa584b7a077355fe3c517612e4dd23c/c31c2/github-pr-plugin.png 842w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id=\"创建项目\"><a href=\"#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>创建项目</h3>\n<h4 id=\"创建一个-freestyle-项目\"><a href=\"#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-freestyle-%E9%A1%B9%E7%9B%AE\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>创建一个 Freestyle 项目</h4>\n<p>以打包 RN 为例：</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/644d0c5813f82612eb05bdb95755c827/995af/freestyle-project.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 69.50578338590957%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABuklEQVQ4y41TWW7rMAzMsXuifvUaPUPRjwaF4y1eJdmWLS9hObSV2OnDQwUMTEnUkBzSp842NDhLTasZSmCamqHWs0aJjTPYj/12v4MbezrRtrquoyzLSCtNqlaklKKyrKiqKtLayBm+YsNHIVi7Q0PzPNPpdrsRME0TGWOo73u2R3LOSRCc/2XBTwiZbT0YV5JhGAQgblqO3Fka+c7DueGw94D/PC9rhlim6ylJr1xmeSduQdh29yA+0H4PjKMjZVrOct4RtlYItdZSKjQBeVEUdLlcBDj3pJ7YWitSVazpNO8IcYGmFEwCIsmOSeHsAcI98AYJhGFIWVE9muIJgyCgOI6FCA9QOvDQzx2ADJ0b5X1SYGymByEufSYgBJ61+k22TkJ2Ze1rc8yw763MHMrN81y085r9D/CBLypcll2XNXcpTlKq61ocAAj/r1KfgRlEpw8Z1oYz5L/Bl3Ifm6182MjCN2PfHMxrpZ5K7mxLURqzFvyrNVq6F0WRNApf6SRLgQogjdfbMmFZ1XTNy7XkZSP8jEJ6eX2j949v+opzzspQmqaUJIloCjvgWfT6+hk9n88SEP7I8Ad8mTjhTxzWDAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"freestyle\"\n        title=\"\"\n        src=\"/blog/static/644d0c5813f82612eb05bdb95755c827/b9e4f/freestyle-project.png\"\n        srcset=\"/blog/static/644d0c5813f82612eb05bdb95755c827/cf440/freestyle-project.png 148w,\n/blog/static/644d0c5813f82612eb05bdb95755c827/d2d38/freestyle-project.png 295w,\n/blog/static/644d0c5813f82612eb05bdb95755c827/b9e4f/freestyle-project.png 590w,\n/blog/static/644d0c5813f82612eb05bdb95755c827/f9b6a/freestyle-project.png 885w,\n/blog/static/644d0c5813f82612eb05bdb95755c827/2d849/freestyle-project.png 1180w,\n/blog/static/644d0c5813f82612eb05bdb95755c827/995af/freestyle-project.png 1902w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol>\n<li>配置 github 仓库信息：仓库地址；触发 <code class=\"language-text\">branch</code> 使用 <code class=\"language-text\">**</code></li>\n<li>设置构建触发器 <code class=\"language-text\">Build Triggers</code></li>\n</ol>\n<h4 id=\"触发与权限控制\"><a href=\"#%E8%A7%A6%E5%8F%91%E4%B8%8E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>触发与权限控制</h4>\n<p>设置 build triggers</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/be7d30691bf6265b9833d8d20bab79a0/bda01/build-trigger.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 80.58455114822547%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABw0lEQVQ4y42U2Y7qMBBE/f8fyAsSOySBBC9hX9S3TzNGngxIF6kUr+VydRm33W5ltVoZmqaR3W4n+/1e1uu1LJdLa7OmbVvpus7AGvohhDe899L3vTgm5/O5TCYTG7xer3I8HuV+vxvof8PlcjHk9vl8EZdSNDVVVRnqurYT8+L/AYT94STrrRfX7r2qm8pisZDD4aCnnOV2u31VxdwnoC6ko7imS1LVjfpXmzp8gPR0Ov0CYxwY1BZfAI9jjLbvqmpdjMEKAhlGM5FS+gPG2YzfrKc4FItCQgwpBzoauUIMlAQlGDNLVMXz+ZTh7/l42E1cuflbuyR86MbsMQXJHkLW9z8KkQ24wmazeSvOpKb6bUV834K9gLb3QTofX4QEmMiUZv8iyx7qhk1VS6WHIoBCAZQmVde04UWIKrIIMJxvrlxJ2HpVEtWCH3Vl0YL2g84ZIeogpcrg05Vf32jz7MEzXhR4+dfbYY5XQai5Nh7mKDA+VAgRT5XvMKuWkFwUFJKrodF/PNQcsg5V5R9D0vWdvrhOLXHD8A6jUkYG5aPRSMbjsQV8NpvJdDo14LvlEDW8kmERPilEDRvxmHCXIIso/wdcc8acwopuegAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"build-trigger\"\n        title=\"\"\n        src=\"/blog/static/be7d30691bf6265b9833d8d20bab79a0/b9e4f/build-trigger.png\"\n        srcset=\"/blog/static/be7d30691bf6265b9833d8d20bab79a0/cf440/build-trigger.png 148w,\n/blog/static/be7d30691bf6265b9833d8d20bab79a0/d2d38/build-trigger.png 295w,\n/blog/static/be7d30691bf6265b9833d8d20bab79a0/b9e4f/build-trigger.png 590w,\n/blog/static/be7d30691bf6265b9833d8d20bab79a0/f9b6a/build-trigger.png 885w,\n/blog/static/be7d30691bf6265b9833d8d20bab79a0/2d849/build-trigger.png 1180w,\n/blog/static/be7d30691bf6265b9833d8d20bab79a0/bda01/build-trigger.png 1916w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol>\n<li>选择 <code class=\"language-text\">GitHub Pull Request Builder</code>，Jenkins 会监听 <code class=\"language-text\">PR</code> 的操作，例如添加评论。</li>\n<li>设置 <code class=\"language-text\">Admin list</code>：非 Admin 人员在 github 创建 <code class=\"language-text\">PR</code> 时，Jenkins 会在 <code class=\"language-text\">PR</code> 下添加一条评论 <code class=\"language-text\">Can one of the admins verify this patch?</code></li>\n<li>设置 <code class=\"language-text\">Trigger phrase</code>：当在 <code class=\"language-text\">PR</code> 下评论该触发词，就会触发后续的构建脚本</li>\n<li>设置轮询时间 <code class=\"language-text\">Crontab line</code></li>\n<li>设置权限：只有白名单人员在 <code class=\"language-text\">PR</code> 下评论才能触发</li>\n</ol>\n<h4 id=\"执行脚本\"><a href=\"#%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>执行脚本</h4>\n<p>通过 Jenkins <code class=\"language-text\">Execute shell</code> 执行编写好的构建脚本。</p>\n<h3 id=\"自动重启\"><a href=\"#%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>自动重启</h3>\n<p><code class=\"language-text\">CI</code> 机器可能意外关机重启，例如：公司断电、不小心触碰插线板等。</p>\n<p>因此，需要在重启打包机器后，自动重启 <code class=\"language-text\">CI</code>，在 Mac 重启启动项里设置执行启动脚本：</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">jenkins --httpPort<span class=\"token operator\">=</span><span class=\"token number\">4567</span></code></pre></div>\n<h2 id=\"脚本\"><a href=\"#%E8%84%9A%E6%9C%AC\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>脚本</h2>\n<p>编写的脚本应该使用最基础的语言，例如 <code class=\"language-text\">bash</code>、<code class=\"language-text\">make</code>，以及基础 <code class=\"language-text\">nodejs</code>。</p>\n<p>不应该使用 <code class=\"language-text\">nodejs</code> 的一些第三方库，增加脚本依赖与复杂度。</p>\n<h3 id=\"测试\"><a href=\"#%E6%B5%8B%E8%AF%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>测试</h3>\n<p>单元测试：推荐使用 <code class=\"language-text\">Jest</code></p>\n<p>e2e：推荐使用 <code class=\"language-text\">detox</code></p>\n<p>项目里编写好执行脚本，在 Jenkins <code class=\"language-text\">Execute shell</code> 下配置即可。</p>\n<h3 id=\"打包\"><a href=\"#%E6%89%93%E5%8C%85\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>打包</h3>\n<p>当在 <code class=\"language-text\">PR</code> 下评论 <code class=\"language-text\">build dev</code> | <code class=\"language-text\">build staging</code> | <code class=\"language-text\">build prod</code> 时，\n就会触发：</p>\n<ol>\n<li>自动升级版本号(build + 1)</li>\n<li>将 <code class=\"language-text\">1</code> 的修改，提交 commit 到仓库</li>\n<li>打出相应的版本</li>\n<li>根据 commit 生成 changelog</li>\n<li>将 apk 和 ipa 文件上传到 <a href=\"https://fir.im/apps\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fir</a></li>\n<li>将版本信息通知到 <a href=\"https://slack.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">slack</a>，供 QA 下载测试</li>\n</ol>\n<p>可通过 <a href=\"https://github.com/fastlane/fastlane/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fastlane</a> 解决升级版本号、根据 commit 生成 changelog、提交到 fir 等问题。</p>\n<p><strong>可用的插件，如下：</strong></p>\n<ul>\n<li><a href=\"https://github.com/SiarheiFedartsou/fastlane-plugin-versioning\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fastlane-plugin-versioning</a></li>\n<li><a href=\"https://github.com/beplus/fastlane-plugin-versioning_android\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fastlane-plugin-versioning_android</a></li>\n<li><a href=\"https://github.com/whlsxl/firim\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fastlane-plugin-firim</a></li>\n</ul>\n<p>打包的具体流程 iOS 和 Android 有很大不同。</p>\n<p><strong>iOS：</strong></p>\n<p>iOS 相对来说简单很多，配置好证书问题，完全可通过 fastlane 生成 ipa 文件，\n并发布到 fir 和 testflight。</p>\n<p><strong>Android：</strong></p>\n<p>Android 复杂很多，涉及以下流程，并且需要手动编写脚本解决。</p>\n<h4 id=\"1-生成-apk\"><a href=\"#1-%E7%94%9F%E6%88%90-apk\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 生成 apk</h4>\n<p><code class=\"language-text\">app/build.gradle</code> 文件配置后，执行</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./gradlew assembleRelease</code></pre></div>\n<h4 id=\"2-加固\"><a href=\"#2-%E5%8A%A0%E5%9B%BA\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 加固</h4>\n<p>加固是对应用程序进行深度加密处理，防止应用在上线后被反编译、破解、恶意篡改、二次打包和内存截取等多种威胁，保护数据信息不轻易被黑客窃取。</p>\n<p>可使用「360 加固保」，官网下载地址: <a href=\"https://jiagu.360.cn/#/global/download\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Mac 版本</a>。</p>\n<p>将文件解压，我们真正需要的不是加固助手客户端，而是 <code class=\"language-text\">jiagu</code> 目录下的 <code class=\"language-text\">jar</code> 包。</p>\n<p>有了 <code class=\"language-text\">jar</code> 包之后，我们就可以编写脚本来完成加固，而不需要通过客户端上传。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">apkPath</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n<span class=\"token assign-left variable\">apkName</span><span class=\"token operator\">=</span><span class=\"token variable\">$2</span>\n\njava -jar ~/work/jiagu/jiagu.jar -jiagu <span class=\"token variable\">${apkPath}</span>/<span class=\"token variable\">${apkName}</span>.apk <span class=\"token variable\">${apkPath}</span>\n<span class=\"token function\">mv</span> <span class=\"token variable\">${apkPath}</span>/<span class=\"token variable\">${apkName}</span>_*_jiagu.apk <span class=\"token variable\">${apkPath}</span>/<span class=\"token variable\">${apkName}</span>-jiagu-sign.apk</code></pre></div>\n<p>执行加固之后，生成 <code class=\"language-text\">app-release-jiagu-sign.apk</code></p>\n<h4 id=\"3-zipalign\"><a href=\"#3-zipalign\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. zipalign</h4>\n<p><a href=\"https://developer.android.com/studio/command-line/zipalign\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">zipalign</a> 是 Android SDK 自带的工具，用于优化应用与 Android 系统的交互效率，提高应用运行性能。</p>\n<p><strong>上架 Google Play 必须经过 zipalign 工具优化</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> zipalign <span class=\"token operator\">=</span> <span class=\"token string\">'~/Library/Android/sdk/build-tools/27.0.3/zipalign'</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">zalign</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">apkName<span class=\"token punctuation\">,</span> apkPath</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zipalign...'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> suffix <span class=\"token operator\">=</span> <span class=\"token string\">'jiagu-zipalign.apk'</span>\n  <span class=\"token function\">execSync</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>zipalign<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> -v 4 </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>jiaguSuffix<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>suffix<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rename zipalign apk...'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">execSync</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mv </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>suffix<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>apkName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>jiaguSuffix<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>执行 zipalign 生成 <code class=\"language-text\">app-release-jiagu-zipalign.apk</code>，重命名为 <code class=\"language-text\">app-release-jiagu-sign.apk</code>。</p>\n<h4 id=\"4-签名\"><a href=\"#4-%E7%AD%BE%E5%90%8D\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 签名</h4>\n<p>经过 <code class=\"language-text\">加固</code> 和 <code class=\"language-text\">zipalign</code> 后的 apk，需要重新签名，签名可参考 <a href=\"https://developer.android.com/studio/publish/app-signing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sign your app</a>。</p>\n<p>签名过程需要交互式的输入 <code class=\"language-text\">keystore</code> 密码，脚本使用 <code class=\"language-text\">expect</code> 编写，简单教程可见 <a href=\"https://gist.github.com/Fluidbyte/6294378\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Basic principles of using tcl-expect scripts</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"expect\"><pre class=\"language-expect\"><code class=\"language-expect\">#!/usr/bin/expect\n\nset user root\nset passwd [lindex $argv 0]\nset signer [lindex $argv 1]\nset keystore [lindex $argv 2]\nset apkPath [lindex $argv 3]\n\nspawn ${signer} sign -ks ${keystore} ${apkPath}\nexpect &quot;Keystore password for signer #1:&quot;\nsend &quot;${passwd}\\r&quot;\n\ninteract</code></pre></div>\n<h4 id=\"5-多渠道包\"><a href=\"#5-%E5%A4%9A%E6%B8%A0%E9%81%93%E5%8C%85\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 多渠道包</h4>\n<p>如果在 <code class=\"language-text\">build.gradle</code> 文件配置 <code class=\"language-text\">productFlavors</code> 渠道信息，那么生成每个渠道包都必须重新执行一次编译。</p>\n<p>也就是说如果有 10 个渠道，一个渠道包需要 4 分钟，那么就需要 40 分钟完成一次打包，十分耗时，必须寻找其他方式。</p>\n<p>目前生成渠道包的方案用的是美团的 <a href=\"https://github.com/Meituan-Dianping/walle\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">walle</a>，原理是在 <code class=\"language-text\">APK Signing Block</code> 区块写入渠道信息，\n然后在统计的时候，读取渠道信息。</p>\n<p>更多详细信息可参考： <a href=\"https://tech.meituan.com/2017/01/13/android-apk-v2-signature-scheme.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">新一代开源 Android 渠道包生成工具 Walle</a>。</p>\n<blockquote>\n<p>使用 <code class=\"language-text\">walle</code> 后，渠道信息不能再以 <code class=\"language-text\">AndroidManifest.xml</code> 配置为准，必须从 <code class=\"language-text\">APK Signing Block</code> 区块获取渠道信息后，动态设置。</p>\n</blockquote>\n<h4 id=\"6-发布到应用商店\"><a href=\"#6-%E5%8F%91%E5%B8%83%E5%88%B0%E5%BA%94%E7%94%A8%E5%95%86%E5%BA%97\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. 发布到应用商店</h4>\n<p>由于国内应用商店不开放接口，所以大部分还是需要手动上传。</p>\n<h3 id=\"通知结果\"><a href=\"#%E9%80%9A%E7%9F%A5%E7%BB%93%E6%9E%9C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通知结果</h3>\n<p>当生成的 apk/ipa 包上传到 fir 后，<a href=\"https://fir.im/docs/apps_show\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">通过 fir 接口</a>，获取新上传的包信息，\n将信息组装成 slack 接收的格式，发送到 slack channel。</p>\n<h3 id=\"生成-release-note\"><a href=\"#%E7%94%9F%E6%88%90-release-note\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生成 release note</h3>\n<p>为了生成可读性强的 release note，<code class=\"language-text\">commit message</code> 需要遵循约定好的规范。</p>\n<p>开源社区有很多不错的规范，这里比较推荐 <a href=\"https://github.com/angular/angular/blob/master/CONTRIBUTING.md#commit\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Angular Commit Message Guidelines</a>，文档齐全、详细。</p>\n<p>并且，我们可以利用 <a href=\"https://github.com/conventional-changelog/conventional-changelog\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">conventional-changelog</a> 来生成如下可读性不错的 changelog。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Features\n  - support dynamic directive arguments for v-on, v-bind and custom directives (#9373)\n\nImprovements\n  - improve scoped slots change detection accuracy (#9371)\n\nBug Fixes\n  - fix checkbox event edge case in Firefox (#1868)</code></pre></div>\n<p>我在文章 <a href=\"../developmemt-guidelines\">团队开发规范</a> 里有更多说明，这里就不展开说了。</p>\n<p>生成 changelog 脚本 <code class=\"language-text\">gen-release-note.js</code> 如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> version <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VERSION</span>\n<span class=\"token keyword\">const</span> cc <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'conventional-changelog'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">./RELEASE_NOTE</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>version <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>version<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.md</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> fileStream <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createWriteStream</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n<span class=\"token function\">cc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  preset<span class=\"token punctuation\">:</span> <span class=\"token string\">'angular'</span><span class=\"token punctuation\">,</span>\n  pkg<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pkg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      pkg<span class=\"token punctuation\">.</span>version <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">v</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>version<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n      <span class=\"token keyword\">return</span> pkg\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>fileStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'close'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Generated release note at </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>file<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"生成-tag\"><a href=\"#%E7%94%9F%E6%88%90-tag\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生成 tag</h3>\n<p>新版本发布之后，自动生成 git tag，并将 tag 和 release note 更新至 github。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">set</span> -e\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> -z <span class=\"token variable\">$1</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Enter new version(SemVer): \"</span>\n  <span class=\"token builtin class-name\">read</span> -r VERSION\n<span class=\"token keyword\">else</span>\n  <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">read</span> -p <span class=\"token string\">\"Releasing <span class=\"token variable\">$VERSION</span> - are you sure? (y/n) \"</span> -n <span class=\"token number\">1</span> -r\n<span class=\"token builtin class-name\">echo</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token environment constant\">$REPLY</span> <span class=\"token operator\">=</span>~ ^<span class=\"token punctuation\">[</span>Yy<span class=\"token punctuation\">]</span>$ <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Releasing <span class=\"token variable\">$VERSION</span> ...\"</span>\n\n  <span class=\"token comment\"># generate release note</span>\n  node ./scripts/gen-release-note <span class=\"token variable\">$VERSION</span>\n\n  <span class=\"token comment\"># format message</span>\n  <span class=\"token assign-left variable\">rNote</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> RELEASE_NOTE_$VERSION.md<span class=\"token variable\">)</span></span>\"</span>\n  <span class=\"token assign-left variable\">rNote</span><span class=\"token operator\">=</span><span class=\"token variable\">${rNote<span class=\"token operator\">/</span><span class=\"token operator\">/</span>\\<span class=\"token operator\">#</span>\\<span class=\"token operator\">#</span>\\<span class=\"token operator\">#</span><span class=\"token operator\">/</span>👉}</span>\n  <span class=\"token assign-left variable\">rNote</span><span class=\"token operator\">=</span><span class=\"token variable\">${rNote<span class=\"token operator\">/</span>\\<span class=\"token operator\">#</span>\\<span class=\"token operator\">#</span><span class=\"token operator\">/</span>👇👇}</span>\n\n  <span class=\"token comment\"># add tag version</span>\n  <span class=\"token function\">git</span> tag -a <span class=\"token string\">\"v<span class=\"token variable\">$VERSION</span>\"</span> -m <span class=\"token string\">\"<span class=\"token variable\">$rNote</span>\"</span>\n\n  <span class=\"token comment\"># publish</span>\n  <span class=\"token function\">git</span> push origin refs/tags/v<span class=\"token string\">\"<span class=\"token variable\">$VERSION</span>\"</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<h2 id=\"总结\"><a href=\"#%E6%80%BB%E7%BB%93\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>总结</h2>\n<p>在如上的流程中，基本实现了针对 RN 项目的自动化构建，能有效提升开发效率，使开发流程更可靠。</p>\n<p>当然，还有很多优化的点，例如：</p>\n<ol>\n<li>使用 docker 将环境隔离开</li>\n<li>Android 各个渠道自动发布</li>\n<li>自动提交版本日志到应用商店</li>\n<li>…</li>\n</ol>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://facebook.github.io/react-native/docs/running-on-device\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Running On Device</a></li>\n<li><a href=\"https://developer.android.com/studio/publish/app-signing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Sign your app</a></li>\n<li><a href=\"https://facebook.github.io/react-native/docs/signed-apk-android\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Publishing to Google Play Store</a></li>\n<li><a href=\"https://developer.android.com/studio/command-line/zipalign\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">zipalign</a></li>\n<li><a href=\"https://tech.meituan.com/2017/01/13/android-apk-v2-signature-scheme.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">新一代开源 Android 渠道包生成工具 Walle</a></li>\n<li><a href=\"https://gist.github.com/Fluidbyte/6294378\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Basic principles of using tcl-expect scripts</a></li>\n<li><a href=\"https://jenkins.io/doc/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Jenkins doc</a></li>\n<li><a href=\"https://debugtalk.com/post/iOS-Android-Packing-with-Jenkins/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">使用Jenkins搭建iOS/Android持续集成打包平台 | DebugTalk</a></li>\n<li><a href=\"https://stackoverflow.com/questions/14274293/show-current-state-of-jenkins-build-on-github-repo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">构建完成后 github commit status 设置不成功</a></li>\n<li><a href=\"https://github.com/fastlane/fastlane/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fastlane</a></li>\n</ul>","timeToRead":18,"frontmatter":{"title":"搭建 RN 项目的 CI/CD","date":"July 26, 2019","spoiler":"使用 Jenkins 自动化 RN 项目单元测试、构建、发布"},"fields":{"slug":"/ci-cd-for-react-native-app/","langKey":"en"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/ci-cd-for-react-native-app/","previous":{"fields":{"slug":"/developmemt-guidelines/","langKey":"en","directoryName":"developmemt-guidelines","maybeAbsoluteLinks":[]},"frontmatter":{"title":"团队开发规范"}},"next":null,"translations":[],"translatedLinks":[]}}}